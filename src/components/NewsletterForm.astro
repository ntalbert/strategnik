---
interface Props {
  variant?: 'default' | 'compact' | 'inline';
  heading?: string;
  description?: string;
}

const {
  variant = 'default',
  heading = "Get the field notes",
  description = "Observations on B2B SaaS marketing, demand generation, and the physics of growth."
} = Astro.props;

// Replace with your Google Apps Script Web App URL
const GOOGLE_SCRIPT_URL = import.meta.env.PUBLIC_GOOGLE_SCRIPT_URL || "";
---

{variant === 'default' && (
  <div class="section border-t border-gray-800">
    <div class="container-narrow">
      <p class="section-label">Newsletter</p>
      <h2 class="text-display mb-4">{heading}</h2>
      <p class="text-body-lg text-gray-400 mb-8 max-w-prose">{description}</p>
      <form
        id="newsletter-form-default"
        class="flex flex-col sm:flex-row gap-4 max-w-md"
      >
        <input
          type="email"
          name="email"
          placeholder="you@company.com"
          required
          class="flex-grow px-4 py-3 bg-gray-900 border border-gray-700 text-white placeholder-gray-400
                 focus:border-white focus:outline-none transition-colors"
        />
        <button
          type="submit"
          class="px-6 py-3 bg-white text-black hover:bg-gray-200 transition-colors whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Subscribe
        </button>
      </form>
      <p id="newsletter-message-default" class="text-small text-gray-400 mt-4">
        No spam. Unsubscribe anytime.
      </p>
    </div>
  </div>
)}

{variant === 'compact' && (
  <div class="section-sm border-t border-gray-800 mt-16">
    <div class="container-narrow">
      <p class="text-small text-gray-400 mb-4">Stay updated</p>
      <form
        id="newsletter-form-compact"
        class="flex gap-4"
      >
        <input
          type="email"
          name="email"
          placeholder="you@company.com"
          required
          class="flex-grow px-4 py-2 bg-gray-900 border border-gray-700 text-white placeholder-gray-400
                 focus:border-white focus:outline-none transition-colors text-small"
        />
        <button
          type="submit"
          class="text-small text-accent hover:text-white transition-colors whitespace-nowrap"
        >
          Subscribe →
        </button>
      </form>
      <p id="newsletter-message-compact" class="text-small text-gray-400 mt-2 hidden"></p>
    </div>
  </div>
)}

{variant === 'inline' && (
  <form
    id="newsletter-form-inline"
    class="flex gap-4"
  >
    <input
      type="email"
      name="email"
      placeholder="you@company.com"
      required
      class="flex-grow px-4 py-2 bg-gray-900 border border-gray-700 text-white placeholder-gray-400
             focus:border-white focus:outline-none transition-colors text-small"
    />
    <button
      type="submit"
      class="text-small text-accent hover:text-white transition-colors whitespace-nowrap"
    >
      Subscribe →
    </button>
  </form>
)}

<script define:vars={{ GOOGLE_SCRIPT_URL }}>
  document.querySelectorAll('[id^="newsletter-form-"]').forEach(form => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formEl = e.target;
      const variant = formEl.id.replace('newsletter-form-', '');
      const messageEl = document.getElementById(`newsletter-message-${variant}`);
      const submitBtn = formEl.querySelector('button[type="submit"]');
      const emailInput = formEl.querySelector('input[name="email"]');
      const email = emailInput.value;

      // Disable form while submitting
      submitBtn.disabled = true;
      submitBtn.textContent = 'Subscribing...';

      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email, timestamp: new Date().toISOString() }),
        });

        // Show success message
        if (messageEl) {
          messageEl.textContent = "You're subscribed! Thanks for signing up.";
          messageEl.classList.remove('hidden', 'text-red-400');
          messageEl.classList.add('text-green-400');
        }
        emailInput.value = '';
        submitBtn.textContent = 'Subscribed!';

      } catch (error) {
        // Show error message
        if (messageEl) {
          messageEl.textContent = 'Something went wrong. Please try again.';
          messageEl.classList.remove('hidden', 'text-green-400');
          messageEl.classList.add('text-red-400');
        }
        submitBtn.textContent = 'Subscribe';
        submitBtn.disabled = false;
      }
    });
  });
</script>
